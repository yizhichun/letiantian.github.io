<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="乐天笔记, 樂天笔记, 编程" />





  <link rel="alternate" href="/atom.xml" title="樂天笔记" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/content/images/favicon.ico?v=5.1.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="樂天笔记">
<meta property="og:url" content="http://www.letiantian.me/page/10/index.html">
<meta property="og:site_name" content="樂天笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="樂天笔记">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.letiantian.me/page/10/"/>





  <title>樂天笔记</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <img class='bg-image' src="/content/images/bg.jpg" />

  







  <script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=62535551";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>









  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">樂天笔记</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-topics">
          <a href="/topics" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-flask"></i> <br />
            
            专题
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.letiantian.me/2014-10-12-three-models-of-naive-nayes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Letian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/content/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樂天笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014-10-12-three-models-of-naive-nayes/" itemprop="url">朴素贝叶斯的三个常用模型：高斯、多项式、伯努利</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-10-12T18:56:02+08:00">
                October 12th 2014
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>2014-10-12</p>
<p>朴素贝叶斯是一个很不错的分类器，在<a href="/2014-05-20-naive-bayes/">使用朴素贝叶斯分类器划分邮件</a>有关于朴素贝叶斯的简单介绍。</p>
<p>若<strong>一个样本</strong>有n个特征，分别用[latex]x_{1},x_{2},…,x_{n}[/latex]表示，将其划分到类[latex]y_{k}[/latex]的可能性[latex]P(y_{k}|x_{1},x_{2},…,x_{n})[/latex]为：</p>
<p>[latex]<br>P(y_{k}|x_{1},x_{2},…,x_{n}) = P(y_{k})\prod_{i=1}^{n}P(x_{i}|y_{k})<br>[/latex]</p>
<p>上式中等号右侧的各个值可以通过训练得到。根据上面的公式可以求的某个数据属于各个分类的可能性（这些可能性之和不一定是1），该数据应该属于具有最大可能性的分类中。</p>
<p>一般来说，如果一个样本没有特征[latex]x_{i}[/latex]，那么[latex]P(x_{i}|y_{k})[/latex]将不参与计算。不过下面的伯努利模型除外。</p>
<p>以上是朴素贝叶斯的最基本的内容。</p>
<h2 id="高斯模型"><a href="#高斯模型" class="headerlink" title="高斯模型"></a>高斯模型</h2><hr>
<p>有些特征可能是连续型变量，比如说人的身高，物体的长度，这些特征可以转换成离散型的值，比如如果身高在160cm以下，特征值为1；在160cm和170cm之间，特征值为2；在170cm之上，特征值为3。也可以这样转换，将身高转换为3个特征，分别是f1、f2、f3，如果身高是160cm以下，这三个特征的值分别是1、0、0，若身高在170cm之上，这三个特征的值分别是0、0、1。不过这些方式都不够细腻，高斯模型可以解决这个问题。高斯模型假设这些一个特征的所有属于某个类别的观测值符合高斯分布，也就是：</p>
<p>[latex]<br>P(x_{i}|y_{k}) = \frac{1}{\sqrt{2\pi\sigma_{y_{k}}^{2}}}exp( -\frac{(x_{i}-\mu_{y_{k}})^2}  {2\sigma_{y_{k}}^{2}}   )<br>[/latex]</p>
<p>下面看一个sklearn中的示例:</p>
<pre><code>&gt;&gt;&gt; from sklearn import datasets
&gt;&gt;&gt; iris = datasets.load_iris()
&gt;&gt;&gt; iris.feature_names  # 四个特征的名字
[&#39;sepal length (cm)&#39;, &#39;sepal width (cm)&#39;, &#39;petal length (cm)&#39;, &#39;petal width (cm)&#39;]
&gt;&gt;&gt; iris.data
array([[ 5.1,  3.5,  1.4,  0.2],
       [ 4.9,  3. ,  1.4,  0.2],
       [ 4.7,  3.2,  1.3,  0.2],
       [ 4.6,  3.1,  1.5,  0.2],
       [ 5. ,  3.6,  1.4,  0.2],
       [ 5.4,  3.9,  1.7,  0.4],
       [ 4.6,  3.4,  1.4,  0.3],
       [ 5. ,  3.4,  1.5,  0.2],
       ......
       [ 6.5,  3. ,  5.2,  2. ],
       [ 6.2,  3.4,  5.4,  2.3],
       [ 5.9,  3. ,  5.1,  1.8]]) #类型是numpy.array
&gt;&gt;&gt; iris.data.size  
600  #共600/4=150个样本
&gt;&gt;&gt; iris.target_names
array([&#39;setosa&#39;, &#39;versicolor&#39;, &#39;virginica&#39;], 
      dtype=&#39;|S10&#39;)
&gt;&gt;&gt; iris.target
array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,....., 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, ......, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2])
&gt;&gt;&gt; iris.target.size
150
&gt;&gt;&gt; from sklearn.naive_bayes import GaussianNB
&gt;&gt;&gt; clf = GaussianNB()
&gt;&gt;&gt; clf.fit(iris.data, iris.target)
&gt;&gt;&gt; clf.predict(iris.data[0])
array([0])   # 预测正确
&gt;&gt;&gt; clf.predict(iris.data[149])
array([2])   # 预测正确
&gt;&gt;&gt; data = numpy.array([6,4,6,2])
&gt;&gt;&gt; clf.predict(data)
array([2])  # 预测结果很合理
</code></pre><h2 id="多项式模型"><a href="#多项式模型" class="headerlink" title="多项式模型"></a>多项式模型</h2><hr>
<p>该模型常用于文本分类，特征是单词，值是单词的出现次数。</p>
<p>[latex]<br>P(x_{i}|y_{k}) = \frac{N_{y_{k}x_{i}}+\alpha}{N_{y_{k}}+\alpha n}<br>[/latex]</p>
<p>其中，[latex]N_{y_{k}x_{i}}[/latex]是类别[latex]y_{k}[/latex]下特征[latex]x_{i}[/latex]出现的总次数；[latex]N_{y_{k}}[/latex]是类别[latex]y_{k}[/latex]下所有特征出现的总次数。对应到文本分类里，如果单词<code>word</code>在一篇分类为<code>label1</code>的文档中出现了5次，那么[latex]N_{label1,word}[/latex]的值会增加5。如果是去除了重复单词的，那么[latex]N_{label1,word}[/latex]的值会增加1。[latex]n[/latex]是特征的数量，在文本分类中就是去重后的所有单词的数量。[latex]\alpha[/latex]的取值范围是[0,1]，比较常见的是取值为1。</p>
<p>待预测样本中的特征[latex]x_{i}[/latex]在训练时可能没有出现，如果没有出现，则[latex]N_{y_{k}x_{i}}[/latex]值为0，如果直接拿来计算该样本属于某个分类的概率，结果都将是0。在分子中加入[latex]\alpha[/latex]，在分母中加入[latex]\alpha n[/latex]可以解决这个问题。</p>
<p>下面的代码来自sklearn的示例：</p>
<pre><code>&gt;&gt;&gt; import numpy as np
&gt;&gt;&gt; X = np.random.randint(5, size=(6, 100))
&gt;&gt;&gt; y = np.array([1, 2, 3, 4, 5, 6])
&gt;&gt;&gt; from sklearn.naive_bayes import MultinomialNB
&gt;&gt;&gt; clf = MultinomialNB()
&gt;&gt;&gt; clf.fit(X, y)
MultinomialNB(alpha=1.0, class_prior=None, fit_prior=True)
&gt;&gt;&gt; print(clf.predict(X[2]))
[3]
</code></pre><p>值得注意的是，多项式模型在训练一个数据集结束后可以继续训练其他数据集而无需将两个数据集放在一起进行训练。在sklearn中，MultinomialNB()类的partial_fit()方法可以进行这种训练。这种方式特别适合于训练集大到内存无法一次性放入的情况。</p>
<p>在第一次调用<code>partial_fit()</code>时需要给出所有的分类标号。</p>
<pre><code>&gt;&gt;&gt; import numpy
&gt;&gt;&gt; from sklearn.naive_bayes import MultinomialNB
&gt;&gt;&gt; clf = MultinomialNB() 
&gt;&gt;&gt; clf.partial_fit(numpy.array([1,1]), numpy.array([&#39;aa&#39;]), [&#39;aa&#39;,&#39;bb&#39;])
GaussianNB()
&gt;&gt;&gt; clf.partial_fit(numpy.array([6,1]), numpy.array([&#39;bb&#39;]))
GaussianNB()
&gt;&gt;&gt; clf.predict(numpy.array([9,1]))
array([&#39;bb&#39;], 
      dtype=&#39;|S2&#39;)
</code></pre><h2 id="伯努利模型"><a href="#伯努利模型" class="headerlink" title="伯努利模型"></a>伯努利模型</h2><hr>
<p>伯努利模型中，对于一个样本来说，其特征用的是全局的特征。</p>
<p>在伯努利模型中，每个特征的取值是布尔型的，即true和false，或者1和0。在文本分类中，就是一个特征有没有在一个文档中出现。</p>
<p>如果特征值[latex]x_{i}[/latex]值为1,那么</p>
<p>[latex]<br>P(x_{i}|y_{k}) = P(x_{i}=1|y_{k})<br>[/latex]</p>
<p>如果特征值[latex]x_{i}[/latex]值为0,那么</p>
<p>[latex]<br>P(x_{i}|y_{k}) = 1-P(x_{i}=1|y_{k})<br>[/latex]</p>
<p>这意味着，“没有某个特征”也是一个特征。<br>下面的示例来自sklearn官方文档：</p>
<pre><code>&gt;&gt;&gt; import numpy as np
&gt;&gt;&gt; X = np.random.randint(2, size=(6, 100))
&gt;&gt;&gt; Y = np.array([1, 2, 3, 4, 4, 5])
&gt;&gt;&gt; from sklearn.naive_bayes import BernoulliNB
&gt;&gt;&gt; clf = BernoulliNB()
&gt;&gt;&gt; clf.fit(X, Y)
BernoulliNB(alpha=1.0, binarize=0.0, class_prior=None, fit_prior=True)
&gt;&gt;&gt; print(clf.predict(X[2]))
[3]
</code></pre><p>BernoulliNB()类也有partial_fit()函数。</p>
<h2 id="多项式模型和伯努利模型在文本分类中的应用"><a href="#多项式模型和伯努利模型在文本分类中的应用" class="headerlink" title="多项式模型和伯努利模型在文本分类中的应用"></a>多项式模型和伯努利模型在文本分类中的应用</h2><hr>
<p>在<a href="http://blog.163.com/jiayouweijiewj@126/blog/static/1712321772010102802635243/" target="_blank" rel="external">基于naive bayes的文本分类算法</a>给出了很好的解释。</p>
<p>在多项式模型中：</p>
<blockquote>
<p>在多项式模型中， 设某文档d=(t1,t2,…,tk)，tk是该文档中出现过的单词，允许重复，则</p>
<p>先验概率P(c)= 类c下单词总数/整个训练样本的单词总数  </p>
<p>类条件概率P(tk|c)=(类c下单词tk在各个文档中出现过的次数之和+1)/(类c下单词总数+|V|)</p>
<p>V是训练样本的单词表（即抽取单词，单词出现多次，只算一个），|V|则表示训练样本包含多少种单词。 P(tk|c)可以看作是单词tk在证明d属于类c上提供了多大的证据，而P(c)则可以认为是类别c在整体上占多大比例(有多大可能性)。</p>
</blockquote>
<p>在伯努利模型中：</p>
<blockquote>
<p>P(c)= 类c下文件总数/整个训练样本的文件总数  </p>
<p>P(tk|c)=(类c下包含单词tk的文件数+1)/(类c下单词总数+2)</p>
</blockquote>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><hr>
<p><a href="http://scikit-learn.org/stable/modules/naive_bayes.html" target="_blank" rel="external">http://scikit-learn.org/stable/modules/naive_bayes.html</a></p>
<p><a href="http://scikit-learn.org/stable/modules/generated/sklearn.naive_bayes.GaussianNB.html" target="_blank" rel="external">http://scikit-learn.org/stable/modules/generated/sklearn.naive_bayes.GaussianNB.html</a></p>
<p><a href="http://scikit-learn.org/stable/modules/generated/sklearn.naive_bayes.MultinomialNB.html" target="_blank" rel="external">http://scikit-learn.org/stable/modules/generated/sklearn.naive_bayes.MultinomialNB.html</a></p>
<p><a href="http://scikit-learn.org/stable/modules/generated/sklearn.naive_bayes.BernoulliNB.html" target="_blank" rel="external">http://scikit-learn.org/stable/modules/generated/sklearn.naive_bayes.BernoulliNB.html</a></p>
<p><a href="http://cn.soulmachine.me/blog/20100528/" target="_blank" rel="external">http://cn.soulmachine.me/blog/20100528/</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.letiantian.me/2014-10-12-python-sorted-func/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Letian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/content/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樂天笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014-10-12-python-sorted-func/" itemprop="url">使用sorted函数对python中的迭代对象进行排序</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-10-12T10:51:20+08:00">
                October 12th 2014
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>2014-10-12</p>
<p>本文的python版本是2.7。</p>
<p>python中列表自带了一个会改变自身的sort()函数：</p>
<pre><code>&gt;&gt;&gt; a=[1, 3, 5, 2]
&gt;&gt;&gt; a
[1, 3, 5, 2]
&gt;&gt;&gt; a.sort()
&gt;&gt;&gt; a
[1, 2, 3, 5]
</code></pre><p>其实，python也内置了一个很棒的sorted()函数，利用该函数可以对列表、字典等可迭代对象进行排序，它是返回<strong>一个包含排序结果的列表</strong>，并不会改变被排序的对象。</p>
<p>比如，对列表：</p>
<pre><code>&gt;&gt;&gt; a=[1, 3, 5, 2]
&gt;&gt;&gt; sorted(a)  # 升序
[1, 2, 3, 5]
&gt;&gt;&gt; sorted(a, reverse=True)  # 降序
[5, 3, 2, 1]

&gt;&gt;&gt; a
[1, 3, 5, 2]
</code></pre><p>对元组（tuple）：</p>
<pre><code>&gt;&gt;&gt; a=(1, 3, 5, 2)
&gt;&gt;&gt; sorted(a)
[1, 2, 3, 5]
&gt;&gt;&gt; a
(1, 3, 5, 2)
</code></pre><p>对字典而言，其可以按照键来排序，也可以按照值来排序。当然，首先需要将字典转换为可迭代对象：</p>
<pre><code>&gt;&gt;&gt; a = {100:6, 200:3, 60:9}
&gt;&gt;&gt; a.items()
[(200, 3), (60, 9), (100, 6)]
</code></pre><p>根据键来排序：</p>
<pre><code>&gt;&gt;&gt; sorted(a.items(), key = lambda item: item[0])
[(60, 9), (100, 6), (200, 3)]
</code></pre><p>根据值来排序：</p>
<pre><code>&gt;&gt;&gt; sorted(a.items(), key = lambda item: item[1])
[(200, 3), (100, 6), (60, 9)]
</code></pre><p>从列表的例子中可以看出，sorted()可以处理比较复杂的结构，在官方的手册中也给出了比较复杂的例子，例如：</p>
<pre><code>&gt;&gt;&gt; student_tuples = [
    (&#39;john&#39;, &#39;A&#39;, 15),
    (&#39;jane&#39;, &#39;B&#39;, 12),
    (&#39;dave&#39;, &#39;B&#39;, 10),
]
&gt;&gt;&gt; sorted(student_tuples, key=lambda student: student[2])   # sort by age
[(&#39;dave&#39;, &#39;B&#39;, 10), (&#39;jane&#39;, &#39;B&#39;, 12), (&#39;john&#39;, &#39;A&#39;, 15)]
</code></pre><pre><code>&gt;&gt;&gt; class Student:
        def __init__(self, name, grade, age):
            self.name = name
            self.grade = grade
            self.age = age
        def __repr__(self):
            return repr((self.name, self.grade, self.age))
&gt;&gt;&gt; student_objects = [
    Student(&#39;john&#39;, &#39;A&#39;, 15),
    Student(&#39;jane&#39;, &#39;B&#39;, 12),
    Student(&#39;dave&#39;, &#39;B&#39;, 10),
]
&gt;&gt;&gt; sorted(student_objects, key=lambda student: student.age)   # sort by age
[(&#39;dave&#39;, &#39;B&#39;, 10), (&#39;jane&#39;, &#39;B&#39;, 12), (&#39;john&#39;, &#39;A&#39;, 15)]
</code></pre><p>更多内容，可以参考<a href="https://docs.python.org/2/howto/sorting.html" target="_blank" rel="external">https://docs.python.org/2/howto/sorting.html</a>。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.letiantian.me/2014-10-08-ghost-add-tag-cloud/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Letian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/content/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樂天笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014-10-08-ghost-add-tag-cloud/" itemprop="url">为Ghost博客添加标签云</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-10-08T09:54:19+08:00">
                October 8th 2014
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>2014-10-08</p>
<p>当前，Ghost博客并不支持标签云功能。</p>
<p>这是几个解决方案：</p>
<h2 id="在模板中遍历"><a href="#在模板中遍历" class="headerlink" title="在模板中遍历"></a>在模板中遍历</h2><hr>
<p>在某个模板中遍历每一个博客，對每一篇博客遍历其tag，然后将这些tag输出到网页。</p>
<p>这种方法有两个问题：<br>1、输出的标签会有重复。<br>2、性能问题。</p>
<h2 id="手动"><a href="#手动" class="headerlink" title="手动"></a>手动</h2><hr>
<p>手动在模板中某处添加某些常用的标签。</p>
<h2 id="单独一个网站来显示所有标签"><a href="#单独一个网站来显示所有标签" class="headerlink" title="单独一个网站来显示所有标签"></a>单独一个网站来显示所有标签</h2><hr>
<p>假如数据库使用的sqlite，其存放在ghost下的<code>/content/data/</code>目录中，假如使用生产环境，数据库名为<code>ghost.db</code>。<code>ghost.db</code>中，表<code>tags</code>存放了所有的标签信息，表<code>posts_tags</code>存储了文章与标签的对应关系。在表<code>tags</code>中，<code>name</code>字段是标签名称，<code>slug</code>字段用来构造url。</p>
<p>据此，可以再写一个小网站，只显示tag信息，甚至将这个网站以<code>iframe</code>的形式嵌入到ghost的一个页面中。</p>
<h2 id="生成tag信息，放入ghost的一个页面中"><a href="#生成tag信息，放入ghost的一个页面中" class="headerlink" title="生成tag信息，放入ghost的一个页面中"></a>生成tag信息，放入ghost的一个页面中</h2><hr>
<p>只显示标签的基本信息：</p>
<pre><code>select name, slug from tags;
</code></pre><p>同时获取tag对应的文章数量：  </p>
<pre><code>select tags.id,  count(tags.id), tags.name, tags.slug
from tags inner join posts_tags 
on tags.id=posts_tags.tag_id
group by tags.id;
</code></pre><p>下面是一段生成标签云的代码：</p>
<pre><code class="python"># !/usr/bin/python
# -*- encoding:utf-8 -*-
&#39;&#39;&#39;
Created on Oct 8, 2014
@author: letian
&#39;&#39;&#39;

import jinja2
import sqlite3
import sys
reload(sys)
sys.setdefaultencoding(&#39;utf8&#39;) 

DB = &#39;./ghost.db&#39;

template_str = &#39;&#39;&#39;
{% for tag in tags %}
<a href="{{ tag.url }}" style="margin:6px 6px;">{{ tag.name }}</a>
{% endfor %}
&#39;&#39;&#39;
template = jinja2.Template(template_str)

conn = sqlite3.connect(DB)
cursor = conn.cursor()
tags = []
for row in cursor.execute(&quot;select name, slug from tags &quot;):
    tags.append({&#39;name&#39;: row[0], &#39;url&#39;:&#39;/tag/&#39;+row[1]})

print template.render(tags=tags)
</code></pre>
<p>将输出结果复制到某个页面即可。</p>
<h2 id="生成字体大小有变化的标签云"><a href="#生成字体大小有变化的标签云" class="headerlink" title="生成字体大小有变化的标签云"></a>生成字体大小有变化的标签云</h2><hr>
<p>（2015-05-09 添加）  </p>
<pre><code># !/usr/bin/python
# -*- encoding:utf-8 -*-

import jinja2  
import sqlite3
import sys
import random

reload(sys)
sys.setdefaultencoding(&#39;utf8&#39;) 


DB = &#39;./ghost.db&#39;

template_str = &#39;&#39;&#39;  
{% for tag in tags %} <a href="{{ tag.url }}" style="margin:30px 10px; font-size: {{ tag.font_size }}">{{ tag.name }}</a>  {% endfor %}
&#39;&#39;&#39;  
template = jinja2.Template(template_str)

conn = sqlite3.connect(DB)  
cursor = conn.cursor()  
tags = []
tags_dic = []

sql = &#39;&#39;&#39;select tags.name as name, tags.slug as slug, count(*) as num  
         from tags, posts_tags 
         where tags.id = posts_tags.tag_id 
         group by tags.id; &#39;&#39;&#39;
for row in cursor.execute(sql):  
    tags.append(( row[0],  &#39;/tag/&#39;+row[1], row[2] ))  # name, url, num

tags = sorted(tags, key=lambda item: item[2])

font_size = 12
count = 0

for tag in tags:
    count += 1
    if count % 5 == 0: # 5个一组，字体大小下一组比上一组大2
        font_size += 2
    tags_dic.append( {&#39;name&#39;: tag[0], &#39;url&#39;: tag[1], &#39;font_size&#39;: str(font_size) + &#39;px&#39; } ) 

random.shuffle(tags_dic)  # 洗个牌 
print template.render(tags=tags_dic)
</code></pre><p>也是将输出结果复制到某个页面即可。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.letiantian.me/2013-09-05-load-balance/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Letian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/content/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樂天笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2013-09-05-load-balance/" itemprop="url">我所理解的负载均衡</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-10-06T23:46:50+08:00">
                October 6th 2014
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>2013-09-05</p>
<p>这里的“负载均衡”是指在网站建设中应该考虑的“负载均衡”。假设我们要搭建一个网站：aaa.me，我们使用的web服务器每秒能处理100条请求，而aaa.me这个网站最火的时候也只是每秒99条请求，那么我们使用一个服务器是完全可以的。但是若该网站平均每秒的请求是200多次，那么问题就来了：这已经是最好的web服务器了，我该怎么办？同样的情景也适用于数据库。要解决这种问题，就需要了解“负载均衡”的原理了。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2013-09-05-load-balance/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.letiantian.me/2013-09-01-xresources-urxvt/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Letian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/content/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樂天笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2013-09-01-xresources-urxvt/" itemprop="url">Xresources和urxvt</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-10-06T23:25:44+08:00">
                October 6th 2014
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>感谢西城的投稿。</p>
<p>在linux下工作，我们用的最多的，也是最重要的工具自然是终端模拟器。因为我们几乎可以在里面做任何事情。所以选择一个好用的终端模拟器是一个很重要的事情。linux桌面发展到现在，自然有很多种不同的终端模拟器可供选择，首先大多数桌面环境都会提供一个自己的终端实现，kde的konsole，gnome的gnome-terminal，xfce的xfcr-terminal（Terminal）,lxde的lxterminal，e17的terminology，下拉式终端里有kde的yakuake,gnome有guake,tilda。其他的有复古风格的vinterm，轻量级的vilvte等。当然，还有最古老的xterm和urxvt。 linux上的软件大都具有很大的相似性。为了尽可能地给用户以选择和定制的自由，默认情况下几乎都是一个基本的框架，没有什么附加的东西在上面，所有的一切都需要我们自己根据喜好去配置。vim和emacs便是如此，默认的emacs几乎看起来让人难以忍受。xterm和urxvt也如此，没有配置的话看起来就像是五六十年代的东西。但配置过后，其功能和易用性确是任何现有的终端都无法比拟的。下面是从afterstep Wiki上摘的一幅配置过后的效果图:</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2013-09-01-xresources-urxvt/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.letiantian.me/2013-09-01-redis-session-manager/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Letian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/content/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樂天笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2013-09-01-redis-session-manager/" itemprop="url">基于Redis的分布式会话管理系统</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-10-06T23:08:40+08:00">
                October 6th 2014
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>在网站开发中，所谓session，也是一个特殊的cookie，常用于记录用户的登录状态。例如，当用户A正常登录启用的Sessin的网站B时候，网站B并不会将用户名、密码等显式的作为cookie，而是根据用户名、登录时间、登录IP等信息生成一个唯一的ID作为cookie，而在网站的服务器端则会记录该ID对应的用户名、失效时间等信息。这样，服务器要识别用户就是靠这个ID了。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2013-09-01-redis-session-manager/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.letiantian.me/2013-08-10-mysql-charset/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Letian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/content/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樂天笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2013-08-10-mysql-charset/" itemprop="url">关于MySQL的字符集</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-10-06T23:00:53+08:00">
                October 6th 2014
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>以下均在mysql 5.5命令行中运行通过：  </p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2013-08-10-mysql-charset/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.letiantian.me/2014-10-04-asynchronous-requests/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Letian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/content/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樂天笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014-10-04-asynchronous-requests/" itemprop="url">如何将requests变成一个异步HTTP库</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-10-04T10:59:20+08:00">
                October 4th 2014
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>2014-10-04</p>
<p>requests库是python一个优秀的HTTP库，使用它可以非常简单地执行HTTP的各种操作，例如GET、POST等。不过，这个库所执行的网络请求都是同步了，即cpu发出请求指令后，IO执行发送和等待等操作，在这段IO执行的时间里，cpu什么也不做，这样cpu的计算能力就被浪费了。所以，可以尝试把网络请求修改为异步的，也就是在IO发挥作用的这段时间，CPU去做这个程序里的其他事情，等IO收到响应的数据，CPU回来处理。下面介绍一下如何将requests变成一个异步HTTP库。</p>
<h2 id="requests"><a href="#requests" class="headerlink" title="requests"></a>requests</h2><hr>
<p>安装：</p>
<pre><code>sudo pip install requests
</code></pre><p>一个获取页面的示例（test01.py）：</p>
<pre><code># -*- coding: utf-8 -*- 

import sys
reload(sys)
sys.setdefaultencoding(&#39;utf-8&#39;) 

import requests
r = requests.get(&#39;http://letiantian.me/&#39;)
print r.text
</code></pre><p>如果网络没问题，会获取<code>http://letiantian.me/</code>页面的html代码。</p>
<h2 id="gevent"><a href="#gevent" class="headerlink" title="gevent"></a>gevent</h2><hr>
<blockquote>
<p> gevent is a coroutine-based Python networking library that uses greenlet to provide a high-level synchronous API on top of the libev event loop.</p>
</blockquote>
<p>话是这样说，gevent的效果是异步的。</p>
<hr>
<p>安装：</p>
<pre><code>sudo pip install gevent
</code></pre><p>不使用gevent，test02.py代码为：</p>
<pre><code># -*- coding: utf-8 -*- 

import sys
reload(sys)
sys.setdefaultencoding(&#39;utf-8&#39;) 

import urllib2

urls = [&quot;http://letiantian.me/&quot;] *10

def get_content(url):
    data = urllib2.urlopen(url).read()
    return data

for url in urls:
    get_content(url)
</code></pre><p>使用gevent，test03.py代码为：</p>
<pre><code># -*- coding: utf-8 -*- 

import sys
reload(sys)
sys.setdefaultencoding(&#39;utf-8&#39;) 

import gevent
from gevent import monkey
monkey.patch_socket()

import urllib2

urls = [&quot;http://letiantian.me/&quot;] *10

def get_content(url):
    data = urllib2.urlopen(url).read()
    return data


jobs = [gevent.spawn(get_content, url) for url in urls]
gevent.joinall(jobs)

# print jobs[0].value
</code></pre><p>比较两者的运行时间：</p>
<pre><code>zsh &gt;&gt; time  python test02.py 
python test02.py  0.05s user 0.02s system 0% cpu 7.362 total
zsh &gt;&gt; time  python test03.py
python test03.py  0.06s user 0.01s system 3% cpu 2.100 total
</code></pre><p>可见，使用gevent时，cpu利用率较高，且程序速度也较快（3倍速度，也可能更快）。</p>
<h2 id="grequests库：使用gevent封装requests"><a href="#grequests库：使用gevent封装requests" class="headerlink" title="grequests库：使用gevent封装requests"></a>grequests库：使用gevent封装requests</h2><hr>
<p>安装：</p>
<pre><code>sudo pip install grequests
</code></pre><p>使用grequests库，test04.py代码如下：</p>
<pre><code># -*- coding: utf-8 -*- 

import sys
reload(sys)
sys.setdefaultencoding(&#39;utf-8&#39;) 

import grequests

urls = [&quot;http://letiantian.me/&quot;] *10
reqs = [grequests.get(url) for url in urls ]
response = grequests.map(reqs)

response0 = response[0]

# print response0.text
</code></pre><p>运行时间：</p>
<pre><code>zsh &gt;&gt; time  python test04.py
python test04.py  0.13s user 0.06s system 10% cpu 1.698 total
</code></pre><p>grequests库存放在<a href="https://github.com/kennethreitz/grequests" target="_blank" rel="external">https://github.com/kennethreitz/grequests</a>，代码很少，很容易看懂。</p>
<p><strong>下面结合grequests的源码分析一下test04.py。</strong><br><code>grequests.get(url)</code>其实就是<code>grequests.AsyncRequest(&#39;GET&#39;, url)</code>，grequests中是使用了<code>functools.partial</code>对此进行了转换。<br>类<code>AsyncRequest</code>的<code>__init__</code>函数做了一些初始化函数，self.url就是初始化该对象时给出的url，self.session是一个requests.Session()对象。<br>类<code>AsyncRequest</code>有一个send()方法，该方法就是调用self.session的request方法，将请求结果放入self.response中。<br><code>grequests</code>下也有一个send方法，其内容是：</p>
<pre><code>def send(r, pool=None, stream=False):
    if pool != None:
        return pool.spawn(r.send, stream=stream)
    return gevent.spawn(r.send, stream=stream)
</code></pre><p>pool是gevent.pool.Pool的一个实例，用来管理一组greenlet。无论是pool.spawn还是gevent.spawn都是负责执行异步请求。</p>
<p>上面的说通了，那么grequests下的map函数也好理解了。</p>
<pre><code>def map(requests, stream=False, size=None, exception_handler=None):
    requests = list(requests)
    pool = Pool(size) if size else None
    jobs = [send(r, pool, stream=stream) for r in requests]
    gevent.joinall(jobs)
    ret = []
    for request in requests:
        if request.response:
            ret.append(request.response)
        elif exception_handler:
            exception_handler(request, request.exception)
    return ret
</code></pre><p>后面贴了grequests的源码。</p>
<h2 id="requests-futures库"><a href="#requests-futures库" class="headerlink" title="requests-futures库"></a>requests-futures库</h2><hr>
<p><a href="https://github.com/ross/requests-futures" target="_blank" rel="external">requests-futures库</a>也是将requests库封装成了一个异步库，不过使用的是python3中的新特性（在python2中也能使用，但需要额外安装futures库），实现得也很简单，此处就不介绍了。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><hr>
<p><a href="http://www.gevent.org/" target="_blank" rel="external">http://www.gevent.org/</a><br><a href="https://github.com/kennethreitz/grequests" target="_blank" rel="external">https://github.com/kennethreitz/grequests</a><br><a href="http://www.gevent.org/gevent.monkey.html#gevent.monkey.patch_all" target="_blank" rel="external">http://www.gevent.org/gevent.monkey.html#gevent.monkey.patch_all</a><br><a href="https://github.com/ross/requests-futures" target="_blank" rel="external">https://github.com/ross/requests-futures</a><br><a href="https://pypi.python.org/pypi/futures" target="_blank" rel="external">https://pypi.python.org/pypi/futures</a><br><a href="http://www.2cto.com/kf/201308/232824.html" target="_blank" rel="external">http://www.2cto.com/kf/201308/232824.html</a><br><a href="http://www.gevent.org/gevent.pool.html" target="_blank" rel="external">http://www.gevent.org/gevent.pool.html</a></p>
<h2 id="grequests的源码"><a href="#grequests的源码" class="headerlink" title="grequests的源码"></a>grequests的源码</h2><pre><code># -*- coding: utf-8 -*-

&quot;&quot;&quot;
grequests
~~~~~~~~~

This module contains an asynchronous replica of ``requests.api``, powered
by gevent. All API methods return a ``Request`` instance (as opposed to
``Response``). A list of requests can be sent with ``map()``.
&quot;&quot;&quot;
from functools import partial

try:
    import gevent
    from gevent import monkey as curious_george
    from gevent.pool import Pool
except ImportError:
    raise RuntimeError(&#39;Gevent is required for grequests.&#39;)

# Monkey-patch.
curious_george.patch_all(thread=False, select=False)

from requests import Session


__all__ = (
    &#39;map&#39;, &#39;imap&#39;,
    &#39;get&#39;, &#39;options&#39;, &#39;head&#39;, &#39;post&#39;, &#39;put&#39;, &#39;patch&#39;, &#39;delete&#39;, &#39;request&#39;
)


class AsyncRequest(object):
    &quot;&quot;&quot; Asynchronous request.

    Accept same parameters as ``Session.request`` and some additional:

    :param session: Session which will do request
    :param callback: Callback called on response.
                     Same as passing ``hooks={&#39;response&#39;: callback}``
    &quot;&quot;&quot;
    def __init__(self, method, url, **kwargs):
        #: Request method
        self.method = method
        #: URL to request
        self.url = url
        #: Associated ``Session``
        self.session = kwargs.pop(&#39;session&#39;, None)
        if self.session is None:
            self.session = Session()

        callback = kwargs.pop(&#39;callback&#39;, None)
        if callback:
            kwargs[&#39;hooks&#39;] = {&#39;response&#39;: callback}

        #: The rest arguments for ``Session.request``
        self.kwargs = kwargs
        #: Resulting ``Response``
        self.response = None

    def send(self, **kwargs):
        &quot;&quot;&quot;
        Prepares request based on parameter passed to constructor and optional ``kwargs```.
        Then sends request and saves response to :attr:`response`

        :returns: ``Response``
        &quot;&quot;&quot;
        merged_kwargs = {}
        merged_kwargs.update(self.kwargs)
        merged_kwargs.update(kwargs)
        try:
            self.response =  self.session.request(self.method,
                                                self.url, **merged_kwargs)
        except Exception as e:
            self.exception = e
        return self


def send(r, pool=None, stream=False):
    &quot;&quot;&quot;Sends the request object using the specified pool. If a pool isn&#39;t
    specified this method blocks. Pools are useful because you can specify size
    and can hence limit concurrency.&quot;&quot;&quot;
    if pool != None:
        return pool.spawn(r.send, stream=stream)

    return gevent.spawn(r.send, stream=stream)


# Shortcuts for creating AsyncRequest with appropriate HTTP method
get = partial(AsyncRequest, &#39;GET&#39;)
options = partial(AsyncRequest, &#39;OPTIONS&#39;)
head = partial(AsyncRequest, &#39;HEAD&#39;)
post = partial(AsyncRequest, &#39;POST&#39;)
put = partial(AsyncRequest, &#39;PUT&#39;)
patch = partial(AsyncRequest, &#39;PATCH&#39;)
delete = partial(AsyncRequest, &#39;DELETE&#39;)

# synonym
def request(method, url, **kwargs):
    return AsyncRequest(method, url, **kwargs)


def map(requests, stream=False, size=None, exception_handler=None):
    &quot;&quot;&quot;Concurrently converts a list of Requests to Responses.

    :param requests: a collection of Request objects.
    :param stream: If True, the content will not be downloaded immediately.
    :param size: Specifies the number of requests to make at a time. If None, no throttling occurs.
    :param exception_handler: Callback function, called when exception occured. Params: Request, Exception
    &quot;&quot;&quot;

    requests = list(requests)

    pool = Pool(size) if size else None
    jobs = [send(r, pool, stream=stream) for r in requests]
    gevent.joinall(jobs)

    ret = []

    for request in requests:
        if request.response:
            ret.append(request.response)
        elif exception_handler:
            exception_handler(request, request.exception)

    return ret


def imap(requests, stream=False, size=2, exception_handler=None):
    &quot;&quot;&quot;Concurrently converts a generator object of Requests to
    a generator of Responses.

    :param requests: a generator of Request objects.
    :param stream: If True, the content will not be downloaded immediately.
    :param size: Specifies the number of requests to make at a time. default is 2
    :param exception_handler: Callback function, called when exception occured. Params: Request, Exception
    &quot;&quot;&quot;

    pool = Pool(size)

    def send(r):
        return r.send(stream=stream)

    for request in pool.imap_unordered(send, requests):
        if request.response:
            yield request.response
        elif exception_handler:
            exception_handler(request, request.exception)

    pool.join()
</code></pre>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.letiantian.me/2014-09-21-affinity-propagation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Letian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/content/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樂天笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014-09-21-affinity-propagation/" itemprop="url">使用Affinity Propagation进行聚类</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-09-21T20:00:49+08:00">
                September 21st 2014
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>2014-09-21</p>
<p>Affinity Propagation，可以翻译为<code>近邻传播</code>。</p>
<p>它的思路是通过迭代的方法计算出一个数据点更适合和另外哪一个数据点属于一个簇。</p>
<p>AP的论文：<a href="http://www.psi.toronto.edu/affinitypropagation/FreyDueckScience07.pdf" target="_blank" rel="external">Clustering by Passing Messages Between Data Points</a>。</p>
<p><a href="http://www.psi.toronto.edu/index.php?q=affinity%20propagation" target="_blank" rel="external">http://www.psi.toronto.edu/index.php?q=affinity%20propagation</a>提供了相关的论文、数据集、源代码。</p>
<p><a href="http://www.kylen314.com/archives/425" target="_blank" rel="external">近邻传播聚类Affinity Propagation</a>是一篇少有的关于AP的中文博文。</p>
<hr>
<p><a href="http://scikit-learn.org/stable/modules/clustering.html#affinity-propagation" target="_blank" rel="external">http://scikit-learn.org/stable/modules/clustering.html#affinity-propagation</a>中如此介绍AP：</p>
<p>Algorithm description: The messages sent between points belong to one of two categories. The first is the responsibility [latex]r(i, k)[/latex], which is the accumulated evidence that sample k should be the exemplar for sample i. The second is the availability [latex]a(i, k)[/latex] which is the accumulated evidence that sample [latex]i[/latex] should choose sample [latex]k[/latex] to be its exemplar, and considers the values for all other samples that [latex]k[/latex] should be an exemplar. In this way, exemplars are chosen by samples if they are (1) similar enough to many samples and (2) chosen by many samples to be representative of themselves.</p>
<p>More formally, the responsibility of a sample [latex]k[/latex] to be the exemplar of sample [latex]i[/latex] is given by:</p>
<p>[latex]<br>r(i, k) \gets s(i,k) - max_{k’ \neq k}[a(i+k’) + s(i+k’)]<br>[/latex]</p>
<p>Where [latex]s(i, k)[/latex] is the similarity between samples [latex]i[/latex] and [latex]k[/latex]. The availability of sample [latex]k[/latex] to be the exemplar of sample [latex]i[/latex] is given by:</p>
<p>[latex]<br>a(i, k) \gets min[0, r(k,k)+\sum_{i’ \neq i, i’ \neq k} r(i’, k)]<br>[/latex]</p>
<p>To begin with, all values for [latex]r[/latex] and [latex]a[/latex] are set to zero, and the calculation of each iterates until convergence.</p>
<hr>
<p><a href="http://www.biomedcentral.com/1471-2105/10/99" target="_blank" rel="external">http://www.biomedcentral.com/1471-2105/10/99</a>中如此介绍AP：</p>
<p>Affinity Propagation (AP) identifies cluster centers, or exemplars, from the graph, which in some sense are a representative member of the cluster. Initially, all nodes are considered as exemplars, though each node is manually assigned a “preference” that it should be chosen as an exemplar. If no prior knowledge is available on which nodes should be favored as exemplars, then all nodes can be assigned the same preference value – where the magnitude can be used to control cluster granularity. For each node i and each candidate exemplar k, AP computes the “responsibility” [latex]r(i, k)[/latex], which indicates how well suited [latex]k[/latex] is as an exemplar for i, and the “availability” [latex]a(i, k)[/latex] reflecting the evidence that [latex]i[/latex] should choose [latex]k[/latex] as an exemplar. </p>
<p>[latex]<br>r(i, k) \gets s(i,k) - max_{k’ \neq k}[a(i+k’) + s(i+k’)]<br>[/latex]</p>
<p>[latex]<br>a(i, k) \gets min[0, r(k,k)+\sum_{i’ \neq i, i’ \neq k} r(i’, k)]<br>[/latex]</p>
<p>Where the matrix [latex]s(i, k)[/latex] denotes the similarity (eg. edge weight) between the two nodes [latex]i[/latex] and [latex]k[/latex], and the diagonal of this matrix contains the preferences for each node. The above two equations are iterated until a good set of exemplars emerges. Each node [latex]i[/latex] can then be assigned to the exemplar [latex]k[/latex] which maximizes the sum [latex]a(i, k) + r(i, k)[/latex], and if [latex]i = k[/latex], then [latex]i[/latex] is an exemplar. A damping factor between 0 and 1 is used to control for numerical oscillations. </p>
<hr>
<p><strong>不过上面少介绍了</strong>[latex]a(k,k)[/latex]：</p>
<p>[latex]<br>a(k,k) \gets \sum_{i’ \neq k} max(0, r(i’, k))<br>[/latex]</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/9/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><span class="space">&hellip;</span><a class="page-number" href="/page/24/">24</a><a class="extend next" rel="next" href="/page/11/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/content/images/avatar.jpg"
               alt="Letian" />
          <p class="site-author-name" itemprop="name">Letian</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">209</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">43</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/letiantian" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Letian</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  
    
    <script>
      var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "0b5e0b416d0b4d9a845ed9b2e72ddc70",
        target: "cloud-tie-wrapper"
      };
    </script>
    <script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script>
  










  





  

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['[latex]','[/latex]'], ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        },
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  


  <!-- highlight -->
  <script src="/highlight/highlight.min.js"></script>
  <link rel="stylesheet" href="/highlight/styles/github.css">

  <script>
    // 高亮
    hljs.initHighlightingOnLoad();
  </script>

</body>
</html>
